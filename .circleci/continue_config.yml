version: 2.1

defaults: &defaults

orbs:
  aws-cli: circleci/aws-cli@3.1.4
  newman: postman/newman@1.0.0
  android: circleci/android@2.1.2

parameters:
  author:
    type: string
    default: "not_username"
  branchy:
    type: string
    default: << pipeline.git.branch >>

jobs:
  test:
    docker:
      - image: cimg/node:17.1.0
        auth:
          username: $DOCKER_USERNAME
          password: $DOCKER_PASSWORD
    steps:
      - checkout
      - run: echo << pipeline.id >>
      - run: echo 'export PIPELINE_ID=<< pipeline.id >>' >> "$BASH_ENV"
      - run: echo $PIPELINE_ID
#      - run: python3 fail.py
      - run: 
          name: Rerun Workflow for Failed tests
          command: |
            echo 'export PIPELINE_ID=<< pipeline.id >>' >> "$BASH_ENV"
            python3 rerun-failed.py
          when: on_fail
      - run: echo << parameter.branchy >>
  build:
    docker:
      - image: cimg/node:19.9.0
    steps:
      - checkout
      - run: 
          command: |
            sudo apt-get update
            sudo apt-get install curl
            curl --version
      - run: curl --version


workflows:
  test:
    jobs:
      - test
      - build

# VS Code Extensi son Version: 1.5.1